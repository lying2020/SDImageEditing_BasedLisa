# 代码重构说明

## 📋 重构目标

将 `demo_single.py` 和 `demo_batch.py` 中的重复代码提取到 `project.py` 中，避免代码重复。

## ✅ 已完成的工作

### 1. `project.py` 中新增的内容

#### 路径设置
- `project_root`: 项目根目录
- `src_path`: src 目录路径
- 自动添加到 `sys.path`
- 自动设置 `SMARTFREEEDIT_MODEL_PATH` 环境变量

#### 编辑类型定义
- `EDITING_TYPES`: 编辑类型字典
- `DEFAULT_EDITING_TYPE`: 默认编辑类型（"Local"）

#### 模型加载函数
- `load_models()`: 加载 BrushNet 和基础模型
- 支持从 `config_local.py` 或环境变量读取模型路径

#### 工具函数
- `get_smartfreeedit_pipeline()`: 获取 SmartFreeEdit_Pipeline（延迟导入）

### 2. `demo_single.py` 的修改

**之前**：
- 包含路径设置代码
- 包含编辑类型定义
- 包含 `load_models()` 函数
- 直接导入所有模块

**现在**：
- 从 `project.py` 导入所有公共配置和函数
- 代码更简洁，只关注业务逻辑

```python
# 从 project.py 导入公共配置和函数
import project
from project import (
    load_models,
    EDITING_TYPES,
    DEFAULT_EDITING_TYPE,
    get_smartfreeedit_pipeline
)

# 获取 SmartFreeEdit_Pipeline（延迟导入）
SmartFreeEdit_Pipeline = project.get_smartfreeedit_pipeline()
```

### 3. `demo_batch.py` 的修改

**之前**：
- 包含路径设置代码
- 包含编辑类型定义
- 包含 `load_models()` 函数
- 包含 `edit_image()` 函数（与 demo_single.py 重复）

**现在**：
- 从 `project.py` 导入所有公共配置和函数
- 保留 `edit_image()` 函数（因为批量处理需要）
- 代码更简洁，减少重复

## 📁 文件结构

```
project.py              # 公共配置和函数
├── 路径设置
├── 编辑类型定义
├── 模型加载函数
└── 工具函数

demo_single.py          # 单个例子编辑
├── 从 project.py 导入公共代码
└── edit_image() 函数

demo_batch.py           # 批量编辑
├── 从 project.py 导入公共代码
├── edit_image() 函数（批量处理用）
└── process_batch() 函数
```

## 🔧 使用方式

### 导入公共配置

```python
import project
from project import (
    load_models,
    EDITING_TYPES,
    DEFAULT_EDITING_TYPE,
    get_smartfreeedit_pipeline
)
```

### 使用编辑类型

```python
# 访问编辑类型
for edit_type, description in project.EDITING_TYPES.items():
    print(f"{edit_type}: {description}")

# 使用默认编辑类型
editing_type = project.DEFAULT_EDITING_TYPE
```

### 加载模型

```python
pipe = project.load_models()
```

### 使用 SmartFreeEdit_Pipeline

```python
SmartFreeEdit_Pipeline = project.get_smartfreeedit_pipeline()
# 然后使用 SmartFreeEdit_Pipeline(...)
```

## ✨ 优势

1. **代码复用**：避免在两个 demo 文件中重复相同的代码
2. **易于维护**：修改路径或配置只需在一个地方修改
3. **一致性**：确保所有脚本使用相同的配置和函数
4. **延迟导入**：模型相关模块只在需要时导入，加快启动速度

## 📝 注意事项

1. **延迟导入**：`SmartFreeEdit_Pipeline` 使用延迟导入，避免在导入 `project.py` 时就加载所有模块
2. **文件检查**：`IMAGES_JSON_FILE` 的检查已改为可选，因为某些脚本可能不需要这个文件
3. **向后兼容**：保留了原有的数据集路径配置，不影响现有功能

## 🎯 后续优化建议

1. 可以考虑将 `edit_image()` 函数也提取到 `project.py` 中
2. 可以考虑添加更多的工具函数（如路径处理、文件检查等）
3. 可以考虑添加配置验证函数

---

**重构完成时间**：2025年
